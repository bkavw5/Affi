<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RoPhim - Phim hay cả rổ - Xem Phim Mới HD Online Vietsub</title>
    <meta name="description" content="Xem phim online chất lượng cao, cập nhật phim mới nhanh chóng, đa dạng thể loại từ hành động, tình cảm, kinh dị đến phim Việt Nam, Hàn Quốc, Trung Quốc." />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f0f0f;
            --panel: #1f1f1f;
            --accent: #e50914;
            --accent-hover: #b20710;
            --muted: #aaa;
            --text: #fff;
            --card-radius: 8px;
            --transition: all 0.3s ease;
            --header-height: 70px;
            --section-spacing: 30px;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding-top: var(--header-height);
        }
        header {
            background: #141414;
            padding: 12px 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            z-index: 120;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #2a2a2a;
        }
        #logo img {
            height: 40px;
        }
        #searchContainer {
            flex: 1;
            position: relative;
        }
        #searchInput {
            width: 100%;
            padding: 10px 40px 10px 20px;
            border-radius: 60px;
            border: none;
            background: #222;
            color: var(--text);
            font-size: 16px;
        }
        #searchBtn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 16px;
        }
        .filter-container {
            background: #141414;
            padding: 12px 16px;
            border-bottom: 1px solid #2a2a2a;
        }
        #toggleFilterBtn {
            padding: 10px 20px;
            border-radius: 60px;
            background: var(--accent);
            color: #fff;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        #filterPanel {
            display: none;
            margin-top: 12px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .filter-select {
            padding: 10px;
            border-radius: 6px;
            background: #222;
            color: #fff;
            border: none;
            min-width: 140px;
        }
        #applyFilterBtn {
            padding: 10px 20px;
            border-radius: 6px;
            background: var(--accent);
            color: #fff;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        main {
            padding: 18px 12px 60px;
        }
        h2 {
            margin: 18px 12px 8px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .movie-row {
            display: flex;
            gap: 12px;
            padding: 0 12px 18px;
            overflow-x: auto;
            scroll-behavior: smooth;
        }
        .movie {
            width: 150px;
            background: var(--panel);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            flex-shrink: 0;
            transition: transform .18s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .movie:hover {
            transform: scale(1.05);
        }
        .movie img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            display: block;
        }
        .movie .title {
            padding: 8px;
            font-size: 14px;
            height: 40px;
            overflow: hidden;
            color: #eee;
        }
        .hot-slider {
            position: relative;
            margin: 20px 0 var(--section-spacing);
            height: 500px;
            overflow: hidden;
        }
        .hot-slide {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .hot-slide.active {
            opacity: 1;
        }
        .hot-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .hot-slide-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
            z-index: 2;
        }
        .hot-slide-title {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .hot-slide-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .hot-slide-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        .hot-slide-description {
            max-width: 600px;
            margin-bottom: 20px;
            line-height: 1.5;
            font-size: 1rem;
        }
        .hot-slide-actions {
            display: flex;
            gap: 10px;
        }
        .slider-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            z-index: 10;
            font-size: 24px;
            border-radius: 50%;
        }
        .slider-nav.prev {
            left: 10px;
        }
        .slider-nav.next {
            right: 10px;
        }
        .slider-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        .slider-dot {
            width: 10px;
            height: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }
        .slider-dot.active {
            background: var(--accent);
        }
        .btn {
            padding: 12px 25px;
            border-radius: 30px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .popup {
            position: fixed;
            inset: 0;
            display: none;
            justify-content: center;
            align-items: flex-start;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            overflow: auto;
            padding: 30px 12px;
        }
        .popup-content {
            width: 100%;
            max-width: 1000px;
            background: transparent;
            display: flex;
            flex-direction: column;
        }
        .player-container {
            width: 100%;
            background: black;
            border-radius: 6px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 540px;
            border: 0;
            display: block;
        }
        .popup-body {
            display: flex;
            gap: 18px;
            padding: 16px;
            flex-wrap: wrap;
            background: transparent;
        }
        .popup-body img {
            width: 250px;
            border-radius: 6px;
            object-fit: cover;
        }
        .popup-info {
            flex: 1;
            min-width: 260px;
        }
        .popup-info h3 {
            margin: 0 0 6px;
            font-size: 22px;
        }
        .meta {
            color: var(--muted);
            font-size: 14px;
            line-height: 1.4;
        }
        .desc {
            color: #ddd;
            margin-top: 10px;
            font-size: 15px;
            line-height: 1.5;
            max-height: 100px;
            overflow: hidden;
            transition: max-height .25s ease;
        }
        .desc.expanded {
            max-height: 600px;
        }
        .toggle-btn {
            margin-top: 10px;
            padding: 8px 12px;
            background: #2a2a2a;
            border-radius: 6px;
            border: none;
            color: white;
            cursor: pointer;
        }
        .episodes {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 8px;
        }
        .episodes button {
            padding: 8px;
            background: #222;
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .close-btn {
            position: fixed;
            right: 18px;
            top: 18px;
            font-size: 28px;
            color: white;
            cursor: pointer;
            z-index: 210;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            transition: var(--transition);
        }
        .close-btn:hover {
            background: var(--accent);
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--accent);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 600px) {
            .movie { width: 130px; }
            .hot-slider { height: 300px; }
            .hot-slide-title { font-size: 1.8rem; }
            .hot-slide-description { font-size: 0.9rem; max-width: 100%; }
            iframe { height: 280px; }
            .popup-body { flex-direction: column; align-items: center; }
            .popup-body img { width: 180px; }
        }
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            z-index: 999;
            box-shadow: 0 4px 12px rgba(229, 9, 20, 0.3);
        }
        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }
        .back-to-top:hover {
            background: var(--accent-hover);
            transform: translateY(-5px);
        }
        footer {
            background: var(--panel);
            color: var(--muted);
            padding: 24px 12px;
            text-align: center;
            font-size: 14px;
            border-top: 1px solid #333;
            margin-top: 40px;
        }
        footer .footer-content {
            max-width: 900px;
            margin: 0 auto;
        }
        footer a {
            color: var(--accent);
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <header>
        <div id="logo">
            <img src="https://i.imgur.com/NEqqdDt.png" alt="Logo" />
        </div>
        <div id="searchContainer">
            <input id="searchInput" placeholder="Nhập từ khóa..." />
            <button id="searchBtn"><i class="fas fa-search"></i></button>
        </div>
    </header>

    <div class="filter-container">
        <button id="toggleFilterBtn">Lọc phim 🎬</button>
        <div id="filterPanel">
            <select id="filterCategory" class="filter-select">
                <option value="">Thể loại</option>
                <option value="hanh-dong">Hành động</option>
                <option value="tinh-cam">Tình cảm</option>
                <option value="co-trang">Cổ trang</option>
                <option value="kinh-di">Kinh dị</option>
                <option value="chien-tranh">Chiến tranh</option>
                <option value="lich-su">Lịch sử</option>
                <option value="tre-em">Trẻ em</option>
                <option value="vien-tuong">Viễn tưởng</option>
                <option value="tai-lieu">Tài liệu</option>
                <option value="bi-an">Bí ẩn</option>
                <option value="phim-18">Phim 18+</option>
                <option value="tam-ly">Tâm lý</option>
                <option value="the-thao">Thể thao</option>
                <option value="phieu-luu">Phiêu lưu</option>
                <option value="am-nhac">Âm nhạc</option>
                <option value="gia-dinh">Gia đình</option>
                <option value="hoc-duong">Học đường</option>
                <option value="hai-huoc">Hài hước</option>
                <option value="hinh-su">Hình sự</option>
                <option value="vo-thuat">Võ thuật</option>
                <option value="khoa-hoc">Khoa học</option>
                <option value="than-thoai">Thần thoại</option>
                <option value="chinh-kich">Chính kịch</option>
                <option value="kinh-dien">Kinh điển</option>
                <option value="mien-tay">Miền tây</option>
            </select>
            <select id="filterCountry" class="filter-select">
                <option value="">Quốc gia</option>
                <option value="trung-quoc">Trung Quốc</option>
                <option value="han-quoc">Hàn Quốc</option>
                <option value="viet-nam">Việt Nam</option>
                <option value="thai-lan">Thái Lan</option>
                <option value="hong-kong">Hồng Kông</option>
                <option value="phap">Pháp</option>
                <option value="duc">Đức</option>
                <option value="ha-lan">Hà Lan</option>
                <option value="mexico">Mexico</option>
                <option value="thuy-dien">Thụy Điển</option>
                <option value="philippines">Philippines</option>
                <option value="dan-mach">Đan Mạch</option>
                <option value="thuy-si">Thụy Sĩ</option>
                <option value="ukraina">Ukraina</option>
                <option value="au-my">Âu Mỹ</option>
                <option value="an-do">Ấn Độ</option>
                <option value="canada">Canada</option>
                <option value="tay-ban-nha">Tây Ban Nha</option>
                <option value="indonesia">Indonesia</option>
                <option value="ba-lan">Ba Lan</option>
                <option value="malaysia">Malaysia</option>
                <option value="bo-dao-nha">Bồ Đào Nha</option>
                <option value="uae">UAE</option>
                <option value="chau-phi">Châu Phi</option>
                <option value="a-rap-xe-ut">Ả Rập Xê Út</option>
                <option value="nhat-ban">Nhật Bản</option>
                <option value="dai-loan">Đài Loan</option>
                <option value="quoc-gia-khac">Quốc Gia Khác</option>
                <option value="tho-nhi-ky">Thổ Nhĩ Kỳ</option>
                <option value="nga">Nga</option>
                <option value="uc">Úc</option>
                <option value="brazil">Brazil</option>
                <option value="y">Ý</option>
                <option value="na-uy">Na Uy</option>
                <option value="nam-phi">Nam Phi</option>
            </select>
            <select id="filterYear" class="filter-select">
                <option value="">Năm</option>
                <option value="2025">2025</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
                <option value="2021">2021</option>
                <option value="2020">2020</option>
                <option value="2019">2019</option>
                <option value="2018">2018</option>
                <option value="2017">2017</option>
                <option value="2016">2016</option>
                <option value="2015">2015</option>
                <option value="2014">2014</option>
                <option value="2013">2013</option>
                <option value="2012">2012</option>
                <option value="2011">2011</option>
                <option value="2010">2010</option>
                <option value="2009">2009</option>
                <option value="2008">2008</option>
                <option value="2007">2007</option>
                <option value="2006">2006</option>
                <option value="2005">2005</option>
                <option value="2004">2004</option>
                <option value="2003">2003</option>
                <option value="2002">2002</option>
                <option value="2001">2001</option>
                <option value="2000">2000</option>
                <option value="1999">1999</option>
                <option value="1998">1998</option>
                <option value="1997">1997</option>
                <option value="1996">1996</option>
                <option value="1995">1995</option>
                <option value="1994">1994</option>
                <option value="1993">1993</option>
                <option value="1992">1992</option>
                <option value="1991">1991</option>
                <option value="1990">1990</option>
            </select>
            <button id="applyFilterBtn">Áp dụng</button>
        </div>
    </div>

    <main id="main">
        <div id="hotSlider" class="hot-slider">
            <button class="slider-nav prev"><i class="fas fa-chevron-left"></i></button>
            <div id="movies-hot"></div>
            <button class="slider-nav next"><i class="fas fa-chevron-right"></i></button>
            <div class="slider-dots" id="sliderDots"></div>
        </div>
        <h2><i class="fas fa-fire"></i> Sôi Nổi Nhất</h2>
        <div id="movies-hot-row" class="movie-row"></div>
        <h2><i class="fas fa-heart"></i> Yêu Thích Nhất</h2>
        <div id="movies-fav" class="movie-row"></div>
        <h2><i class="fas fa-star"></i> Thể Loại Hot</h2>
        <div id="movies-hot-genre" class="movie-row"></div>
        <h2><i class="fas fa-bolt"></i> Phim Hành Động</h2>
        <div id="movies-hd" class="movie-row"></div>
        <h2><i class="fas fa-heart"></i> Phim Tình Cảm</h2>
        <div id="movies-tc" class="movie-row"></div>
        <h2><i class="fas fa-ghost"></i> Phim Kinh Dị</h2>
        <div id="movies-kd" class="movie-row"></div>
        <h2><i class="fas fa-film"></i> Phim Lẻ</h2>
        <div id="movies-le" class="movie-row"></div>
        <h2><i class="fas fa-tv"></i> Phim Bộ</h2>
        <div id="movies-bo" class="movie-row"></div>
        <h2><i class="fas fa-flag"></i> Phim Việt Nam</h2>
        <div id="movies-viet" class="movie-row"></div>
        <h2><i class="fas fa-flag"></i> Phim Thái Lan</h2>
        <div id="movies-thai" class="movie-row"></div>
        <h2><i class="fas fa-flag"></i> Phim Hàn Quốc</h2>
        <div id="movies-han" class="movie-row"></div>
        <h2><i class="fas fa-flag"></i> Phim Trung Quốc</h2>
        <div id="movies-trung" class="movie-row"></div>
        <h2><i class="fas fa-flag"></i> Phim Âu Mỹ</h2>
        <div id="movies-anh" class="movie-row"></div>
    </main>

    <div id="popup" class="popup" role="dialog" aria-modal="true">
        <span class="close-btn" id="popupClose">×</span>
        <div class="popup-content">
            <div class="player-container" id="player"></div>
            <div class="popup-body">
                <img id="moviePoster" src="" alt="Poster" />
                <div class="popup-info">
                    <h3 id="movieTitle">Tiêu đề</h3>
                    <div id="movieMeta" class="meta"></div>
                    <div id="movieDesc" class="desc"></div>
                    <button id="toggleDescBtn" class="toggle-btn" style="display:none">Xem thêm▼</button>
                    <h4 style="margin-top:12px">Danh sách tập</h4>
                    <div id="episodeList" class="episodes"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="back-to-top" id="backToTop">
        <i class="fas fa-arrow-up"></i>
    </div>

    <footer>
        <div class="footer-content">
            <div id="logo">
                <img src="https://i.imgur.com/HECw3fz.png" alt="Logo" style="height:70px;" />
            </div>
            <p>RoPhim cung cấp thông tin phim hot, cập nhật nhanh các thể loại phim đa dạng, phục vụ người xem phim tại Việt Nam và quốc tế. Chúng tôi luôn cố gắng mang đến trải nghiệm xem phim tốt nhất cho bạn.</p>
            <p>Lưu ý: Chúng tôi từ chối mọi trách nhiệm liên quan đến nội dung hiển thị/tồn tại trên trang. Tất cả video và dữ liệu tại đây đều được tổng hợp từ các nguồn phổ biến trên Internet, và không thuộc quyền sở hữu hay kiểm soát của chúng tôi. Chúng tôi không cung cấp dịch vụ phát trực tuyến chính thức. Nếu bạn cho rằng quyền lợi của mình bị ảnh hưởng, vui lòng <a href="#">liên hệ</a> ngay cho chúng tôi sẽ xử lý và gỡ bỏ nội dung vi phạm kịp thời. Xin cảm ơn sự thông cảm và hợp tác của bạn.</p>
            <p>Copyright &copy; 2025</p>
        </div>
    </footer>

    <script>
        const toggleFilterBtn = document.getElementById("toggleFilterBtn");
        const filterPanel = document.getElementById("filterPanel");
        const applyFilterBtn = document.getElementById("applyFilterBtn");
        const originalMainHtml = document.getElementById("main").innerHTML;

        toggleFilterBtn.addEventListener("click", () => {
            filterPanel.style.display = filterPanel.style.display === "flex" ? "none" : "flex";
        });

        applyFilterBtn.addEventListener("click", async () => {
            const category = document.getElementById("filterCategory").value.trim();
            const country = document.getElementById("filterCountry").value.trim();
            const year = document.getElementById("filterYear").value.trim();

            if (!category && !country && !year) {
                alert("Vui lòng chọn ít nhất một bộ lọc!");
                return;
            }

            const params = new URLSearchParams({ page: 1, limit: 24 });
            if (category) params.append("category", category);
            if (country) params.append("country", country);
            if (year) params.append("year", year);

            const apiUrl = `https://phimapi.com/v1/api/danh-sach/phim-bo?${params.toString()}`;
            try {
                const res = await fetch(apiUrl);
                const data = await res.json();
                const items = data?.data?.items || [];
                const cdn = data?.data?.APP_DOMAIN_CDN_IMAGE || "https://phimimg.com";

                const main = document.getElementById("main");
                main.innerHTML = `
                    <h2><i class="fas fa-filter"></i> Kết quả lọc phim</h2>
                    <div id="filter-results" class="movie-row"></div>
                    <button id="backHomeBtn" style="margin:12px;padding:8px 16px;background:#222;border:none;color:#fff;border-radius:6px;cursor:pointer;"><i class="fas fa-home"></i> Quay về trang chủ</button>
                `;
                renderMovies(items, "filter-results", cdn);

                document.getElementById("backHomeBtn").onclick = () => {
                    main.innerHTML = originalMainHtml;
                    loadInitial();
                };

                filterPanel.style.display = "none";
            } catch (e) {
                console.error("Lỗi lọc phim", e);
                alert("Lỗi khi lọc phim, vui lòng thử lại.");
            }
        });

        function buildImageUrl(path, cdnDomain = "https://phimimg.com") {
            if (!path) return "https://via.placeholder.com/1200x500?text=No+Image";
            if (path.startsWith("http")) return path;
            return cdnDomain.replace(/\/+$/, "") + "/" + path.replace(/^\/+/, "");
        }

        function renderMovies(movies, containerId, cdnDomain = "https://phimimg.com") {
            const el = document.getElementById(containerId);
            if (!el) return;
            el.innerHTML = movies.map(m => {
                const imgPath = m.poster_url || m.thumb_url || "";
                const img = buildImageUrl(imgPath, cdnDomain);
                const safeName = (m.name || m.origin_name || "No title").replace(/"/g, "&quot;");
                return `<div class="movie" data-slug="${m.slug || ''}" onclick="getMovieDetail('${m.slug}')">
                    <img src="${img}" alt="${safeName}" loading="lazy">
                    <div class="title">${safeName}</div>
                </div>`;
            }).join("");
        }

        function renderHotSlider(movies, containerId, cdnDomain = "https://phimimg.com") {
            const el = document.getElementById(containerId);
            if (!el) return;
            el.innerHTML = movies.map(m => {
                const imgPath = m.poster_url || m.thumb_url || "";
                const img = buildImageUrl(imgPath, cdnDomain);
                const safeName = (m.name || m.origin_name || "No title").replace(/"/g, "&quot;");
                const desc = (m.content || "Không có mô tả.").substring(0, 150) + "...";
                const rating = m.tmdb?.vote_average || Math.random() * 5 + 5;
                const year = m.year || "N/A";
                const time = m.time || "N/A";
                const quality = m.quality || "N/A";
                return `
                    <div class="hot-slide">
                        <img src="${img}" alt="${safeName}" loading="lazy">
                        <div class="hot-slide-content">
                            <h2 class="hot-slide-title">${safeName}</h2>
                            <div class="hot-slide-meta">
                                <span><i class="fas fa-star"></i> ${rating.toFixed(1)}/10</span>
                                <span><i class="fas fa-clock"></i> ${time}</span>
                                <span><i class="fas fa-calendar"></i> ${year}</span>
                                <span><i class="fas fa-film"></i> ${quality}</span>
                            </div>
                            <p class="hot-slide-description">${desc}</p>
                            <div class="hot-slide-actions">
                                <button class="btn btn-primary" onclick="getMovieDetail('${m.slug}')"><i class="fas fa-play"></i> Xem ngay</button>
                                <button class="btn btn-secondary"><i class="fas fa-plus"></i> Thêm vào danh sách</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join("");
        }

        async function loadInitial() {
            try {
                const r = await fetch("https://phimapi.com/danh-sach/phim-moi-cap-nhat-v3?page=1");
                const d = await r.json();
                const items = d?.items || [];
                const cdn = d?.APP_DOMAIN_CDN_IMAGE || "https://phimimg.com";

                // Phim nổi bật (slider)
                renderHotSlider(items.slice(0, 10), "movies-hot", cdn);
                initSlider();

                // Sôi nổi nhất
                renderMovies(items.slice(0, 12), "movies-hot-row", cdn);
                // Yêu thích nhất (giả lập từ phim nổi bật)
                renderMovies(items.slice(0, 12).sort(() => Math.random() - 0.5), "movies-fav", cdn);
                // Thể loại hot (giả lập từ phim hành động)
                loadMoviesByCategory("hanh-dong", "movies-hot-genre");
                // Other sections
                loadMoviesByCategory("hanh-dong", "movies-hd");
                loadMoviesByCategory("tinh-cam", "movies-tc");
                loadMoviesByCategory("kinh-di", "movies-kd");
                loadMoviesByType("phim-le", "movies-le");
                loadMoviesByType("phim-bo", "movies-bo");
                loadMoviesByCountry("viet-nam", "movies-viet");
                loadMoviesByCountry("thai-lan", "movies-thai");
                loadMoviesByCountry("han-quoc", "movies-han");
                loadMoviesByCountry("trung-quoc", "movies-trung");
                loadMoviesByCountry("au-my", "movies-anh");
            } catch (e) {
                console.error("Lỗi tải phim nổi bật", e);
            }
        }

        function initSlider() {
            const slider = document.getElementById("hotSlider");
            const slides = slider.querySelectorAll(".hot-slide");
            const dotsContainer = document.getElementById("sliderDots");
            const prevBtn = slider.querySelector(".prev");
            const nextBtn = slider.querySelector(".next");
            let currentIndex = 0;
            const totalSlides = slides.length;

            // Create dots
            dotsContainer.innerHTML = Array(totalSlides).fill().map((_, i) => `
                <div class="slider-dot ${i === 0 ? 'active' : ''}" data-index="${i}"></div>
            `).join("");

            function updateSlider() {
                slides.forEach((slide, i) => {
                    slide.classList.toggle("active", i === currentIndex);
                });
                dotsContainer.querySelectorAll(".slider-dot").forEach((dot, i) => {
                    dot.classList.toggle("active", i === currentIndex);
                });
            }

            prevBtn.addEventListener("click", () => {
                currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
                updateSlider();
            });

            nextBtn.addEventListener("click", () => {
                currentIndex = (currentIndex + 1) % totalSlides;
                updateSlider();
            });

            dotsContainer.addEventListener("click", e => {
                if (e.target.classList.contains("slider-dot")) {
                    currentIndex = parseInt(e.target.dataset.index);
                    updateSlider();
                }
            });

            let autoSlide = setInterval(() => {
                currentIndex = (currentIndex + 1) % totalSlides;
                updateSlider();
            }, 5000);

            slider.addEventListener("mouseenter", () => clearInterval(autoSlide));
            slider.addEventListener("mouseleave", () => {
                autoSlide = setInterval(() => {
                    currentIndex = (currentIndex + 1) % totalSlides;
                    updateSlider();
                }, 5000);
            });
        }

        async function loadMoviesByCategory(slug, containerId) {
            try {
                const r = await fetch(`https://phimapi.com/v1/api/the-loai/${slug}?page=1&limit=12`);
                const d = await r.json();
                const items = d?.data?.items || [];
                const cdn = d?.data?.APP_DOMAIN_CDN_IMAGE || "https://phimimg.com";
                renderMovies(items, containerId, cdn);
            } catch (e) {
                console.error(`Lỗi tải thể loại ${slug}`, e);
            }
        }

        async function loadMoviesByType(slug, containerId) {
            try {
                const r = await fetch(`https://phimapi.com/v1/api/danh-sach/${slug}?page=1&limit=12`);
                const d = await r.json();
                const items = d?.data?.items || [];
                const cdn = d?.data?.APP_DOMAIN_CDN_IMAGE || "https://phimimg.com";
                renderMovies(items, containerId, cdn);
            } catch (e) {
                console.error(`Lỗi tải loại ${slug}`, e);
            }
        }

        async function loadMoviesByCountry(slug, containerId) {
            try {
                const r = await fetch(`https://phimapi.com/v1/api/quoc-gia/${slug}?page=1&limit=12`);
                const d = await r.json();
                const items = d?.data?.items || [];
                const cdn = d?.data?.APP_DOMAIN_CDN_IMAGE || "https://phimimg.com";
                renderMovies(items, containerId, cdn);
            } catch (e) {
                console.error(`Lỗi tải quốc gia ${slug}`, e);
            }
        }

        async function searchMovies(keyword) {
            if (!keyword) return;
            try {
                const r = await fetch(`https://phimapi.com/v1/api/tim-kiem?keyword=${encodeURIComponent(keyword)}&limit=24`);
                const d = await r.json();
                const items = d?.data?.items || [];
                const cdn = d?.data?.APP_DOMAIN_CDN_IMAGE || "https://phimimg.com";

                const main = document.getElementById("main");
                main.innerHTML = `
                    <button id="backHomeBtn" style="margin:12px;padding:8px 16px;background:#222;border:none;color:#fff;border-radius:6px;cursor:pointer;"><i class="fas fa-home"></i> Quay về trang chủ</button>
                    <h2><i class="fas fa-search"></i> Kết quả tìm kiếm: "${escapeHtml(keyword)}"</h2>
                    <div id="search-results" class="movie-row"></div>
                    <h2><i class="fas fa-star"></i> Gợi ý phim</h2>
                    <div id="suggested-movies" class="movie-row"></div>
                `;

                renderMovies(items, "search-results", cdn);

                const hotRes = await fetch("https://phimapi.com/danh-sach/phim-moi-cap-nhat-v3?page=1");
                const hotData = await hotRes.json();
                const hotItems = hotData?.items?.slice(0, 12) || [];
                const hotCdn = hotData?.APP_DOMAIN_CDN_IMAGE || "https://phimimg.com";
                renderMovies(hotItems, "suggested-movies", hotCdn);

                document.getElementById("backHomeBtn").onclick = () => {
                    main.innerHTML = originalMainHtml;
                    loadInitial();
                };
            } catch (e) {
                console.error("Lỗi tìm kiếm", e);
                alert("Lỗi tìm kiếm phim, vui lòng thử lại.");
            }
        }

        function escapeHtml(s) {
            return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
        }

        async function getMovieDetail(slug) {
            if (!slug) return;
            try {
                const r = await fetch(`https://phimapi.com/phim/${slug}`);
                const d = await r.json();
                if (!d?.status) {
                    alert("Không tìm thấy thông tin phim");
                    return;
                }

                const movie = d.movie || {};
                const episodes = d.episodes?.[0]?.server_data || [];
                const cdnDomain = d?.APP_DOMAIN_CDN_IMAGE || "https://phimimg.com";

                if (movie.titleHead) document.title = movie.titleHead;
                if (movie.descriptionHead) {
                    let meta = document.querySelector('meta[name="description"]');
                    if (!meta) {
                        meta = document.createElement("meta");
                        meta.name = "description";
                        document.head.appendChild(meta);
                    }
                    meta.content = movie.descriptionHead;
                }

                const posterUrl = buildImageUrl(movie.poster_url || movie.thumb_url, cdnDomain);
                document.getElementById("moviePoster").src = posterUrl;

                document.getElementById("movieTitle").innerText = `${movie.name || movie.origin_name || "Không tên"} ${movie.year ? "(" + movie.year + ")" : ""}`;

                const genres = (movie.category?.map(c => c.name).join(", ")) || "Không rõ";
                const countries = (movie.country?.map(c => c.name).join(", ")) || "Không rõ";
                document.getElementById("movieMeta").innerHTML = `
                    <i class="fas fa-clock"></i> Thời gian: ${movie.time || 'N/A'} | ${movie.quality || 'N/A'}<br>
                    <i class="fas fa-tags"></i> Thể loại: ${genres}<br>
                    <i class="fas fa-globe"></i> Quốc gia: ${countries}
                `;

                const descEl = document.getElementById("movieDesc");
                const toggleBtn = document.getElementById("toggleDescBtn");
                const descText = movie.content || "Không có mô tả cho phim này.";
                descEl.innerHTML = descText;
                descEl.classList.remove("expanded");
                if (descText.length > 220) {
                    toggleBtn.style.display = "inline-block";
                    toggleBtn.textContent = "Xem thêm▼";
                    toggleBtn.onclick = () => {
                        const expanded = descEl.classList.toggle("expanded");
                        toggleBtn.textContent = expanded ? "Thu gọn▲" : "Xem thêm▼";
                    };
                } else {
                    toggleBtn.style.display = "none";
                }

                const epList = document.getElementById("episodeList");
                epList.innerHTML = episodes.map((ep, i) => {
                    const url = ep.link_embed || ep.link || ep.file || "#";
                    return `<button onclick="playEpisode('${url}')">Tập ${i + 1}</button>`;
                }).join("");

                openPopup();
                if (episodes.length > 0) playEpisode(episodes[0].link_embed || episodes[0].link || episodes[0].file || "#");
            } catch (e) {
                console.error("Lỗi chi tiết phim", e);
                alert("Lỗi tải chi tiết phim, vui lòng thử lại.");
            }
        }

        function playEpisode(url) {
            if (!url || url === "#") return alert("Link không hợp lệ");
            const player = document.getElementById("player");
            player.innerHTML = `<iframe src="${url}" allowfullscreen></iframe>`;
            player.scrollIntoView({ behavior: "smooth", block: "center" });
        }

        function openPopup() {
            document.getElementById("popup").style.display = "flex";
            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        function closePopup() {
            document.getElementById("player").innerHTML = "";
            document.getElementById("popup").style.display = "none";
        }

        document.getElementById("popupClose").addEventListener("click", closePopup);

        document.getElementById("searchBtn").addEventListener("click", () => {
            const kw = document.getElementById("searchInput").value.trim();
            if (!kw) return alert("Vui lòng nhập từ khóa tìm kiếm.");
            searchMovies(kw);
        });

        document.getElementById("searchInput").addEventListener("keypress", e => {
            if (e.key === "Enter") document.getElementById("searchBtn").click();
        });

        document.getElementById("backToTop").addEventListener("click", () => {
            window.scrollTo({ top: 0, behavior: "smooth" });
        });

        window.addEventListener("scroll", () => {
            const backToTop = document.getElementById("backToTop");
            if (window.scrollY > 300) {
                backToTop.classList.add("visible");
            } else {
                backToTop.classList.remove("visible");
            }
        });

        loadInitial();
    </script>
</body>
</html>
