<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizer Nh·∫°c v·ªõi D·∫£i Thanh Tr·∫Øng</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),
        url('https://hinhanhdep.net/wp-content/uploads/2017/11/hinh-nen-anime-4k-dep-17.jpg') center/cover fixed;
      color: white;
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      overflow: hidden;
    }
    .container { width: 100%; max-width: 800px; text-align: center; padding: 20px; z-index: 10; }
    #chooser {
      background: rgba(0,0,0,0.7); border-radius: 15px; padding: 30px;
      box-shadow: 0 0 25px rgba(255,255,255,0.1); backdrop-filter: blur(10px);
    }
    #chooser-dialog { display: flex; flex-direction: column; gap: 20px; }
    .file-upload { position: relative; overflow: hidden; width: 100%; }
    .file-select {
      background: rgba(255,255,255,0.1); border: 2px dashed #fff; border-radius: 10px;
      padding: 15px; color: #fff; cursor: pointer; transition: 0.3s;
    }
    .file-select:hover { background: rgba(255,255,255,0.15); }
    .file-select input[type="file"] {
      position: absolute; inset: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer;
    }
    button {
      background: linear-gradient(45deg,#fff,#ccc); border: none; border-radius: 50px;
      color: #000; padding: 15px; font-size: 16px; font-weight: bold; cursor: pointer;
      transition: 0.3s; box-shadow: 0 5px 15px rgba(255,255,255,0.2);
    }
    button:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255,255,255,0.3); }
    button:active { transform: translateY(1px); }
    button.disabled { background: #666; cursor: not-allowed; box-shadow: none; color: #999; }
    #scene { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; z-index: 1; }
    #scene-canvas { width: 100%; height: 100%; }
    .audio-info {
      position: fixed; bottom: 20px; left: 0; right: 0; text-align: center; z-index: 10;
      background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 10px; margin: 0 20px; backdrop-filter: blur(5px);
    }
    #song-name { font-weight: bold; font-size: 18px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #song-time { font-size: 16px; color: #ccc; }
    .hidden { display: none !important; } .visible { display: flex !important; }
    #spinner-outer { display: flex; justify-content: center; align-items: center; height: 50px; }
    #error {
      position: fixed; inset: 0; background: rgba(0,0,0,0.9);
      display: flex; justify-content: center; align-items: center; z-index: 1000;
    }
    #error-dialog {
      background: #222; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px;
      box-shadow: 0 0 20px rgba(255,0,0,0.5);
    }
    #error-title { color: #FF3366; margin-bottom: 15px; font-size: 24px; }
    #error-button { background: #FF3366; margin-top: 20px; color: #fff; }
    .title { font-size: 32px; margin-bottom: 10px; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
    .subtitle { font-size: 18px; margin-bottom: 30px; color: #ccc; }
    .volume-control {
      position: fixed; top: 20px; right: 20px; z-index: 10; display: flex; align-items: center;
      background: rgba(0,0,0,0.5); padding: 10px 15px; border-radius: 30px; backdrop-filter: blur(5px);
    }
    .volume-control span { margin-right: 10px; font-size: 20px; }
    .volume-control input { width: 100px; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title"></h1>
    <p class="subtitle"></p>
    <div id="chooser">
      <div id="chooser-dialog">
        <input accept="image/*" id="verborgen_file" type="file" hidden />
        <button id="uploadButton" type="button">Ch·ªçn ·∫£nh n·ªÅn</button>
        <div class="file-upload">
          <div class="file-select">
            <input accept="audio/*" id="chooser-input" type="file"/> 
            Ch·ªçn nh·∫°c c·∫ßn ph√°t (MP3, WAV, ...)
          </div>
        </div>
        <p>Ch·ªâ nh·∫≠n file √¢m thanh. File s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω tr·ª±c ti·∫øp tr√™n tr√¨nh duy·ªát.</p>
        <div id="spinner-outer" class="hidden">
          <svg height="30" id="spinner" viewBox="0 0 30 30" width="30">
            <circle class="path" cx="15" cy="15" r="13" fill="none" stroke-linecap="round" stroke-width="2"/>
          </svg>
        </div>
        <button id="chooser-button">Ph√°t Nh·∫°c</button>
      </div>
    </div>
  </div>

  <div id="scene" class="hidden">
    <canvas id="scene-canvas"></canvas>
  </div>

  <div class="audio-info">
    <div id="song-name">Ch∆∞a c√≥ b√†i h√°t</div>
    <div id="song-time">00:00 / 00:00</div>
  </div>

  <div class="volume-control">
    <span>üîä</span>
    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.75">
  </div>

  <div id="error" class="hidden">
    <div id="error-dialog">
      <h1 id="error-title"></h1>
      <p id="error-text"></p>
      <button id="error-button">ƒê√≥ng</button>
    </div>
  </div>

  <script>
    let audioInput, file, fileName = "", playButton, audioContext, audioBufferSourceNode;
    let audioPlaying = false, canvas, ctx, elapsedTime = 0, startTime = 0, durationTime = 0;
    let analyser, audioDrawingArray, animationFrameId, volume = 0.75, audioGainNode;

    window.onload = () => {
      audioContext = window.AudioContext ? new AudioContext() : null;
      if (!audioContext) return showError("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£", "Vui l√≤ng d√πng tr√¨nh duy·ªát hi·ªán ƒë·∫°i h∆°n.");

      audioInput = document.getElementById("chooser-input");
      audioInput.onchange = () => {
        if (audioInput.files.length) {
          file = audioInput.files[0];
          fileName = file.name;
          document.getElementById('song-name').textContent = fileName;
          enableButton();
        }
      };

      playButton = document.getElementById("chooser-button");
      playButton.onclick = handlePlayClick;
      disableButton();

      canvas = document.getElementById("scene-canvas");
      ctx = canvas.getContext("2d");
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      document.getElementById("volume-slider").oninput = e => {
        volume = +e.target.value;
        if (audioGainNode) audioGainNode.gain.value = volume;
      };

      document.getElementById("uploadButton").onclick = () => document.getElementById("verborgen_file").click();
      document.getElementById("verborgen_file").onchange = e => {
        const f = e.target.files[0]; if (!f) return;
        const reader = new FileReader();
        reader.onload = ev => {
          document.body.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)), url(${ev.target.result})`;
        };
        reader.readAsDataURL(f);
      };

      document.getElementById("error-button").onclick = () => document.getElementById("error").className = "hidden";
    };

    const resizeCanvas = () => { if (canvas) { canvas.width = innerWidth; canvas.height = innerHeight; } };
    const disableButton = () => playButton.className = "disabled";
    const enableButton = () => playButton.className = "";

    function handlePlayClick() {
      if (!file || !file.type.startsWith("audio")) return showError("L·ªói!!!", "Vui l√≤ng ch·ªçn file nh·∫°c (MP3, WAV, ...).");
      const reader = new FileReader();
      reader.onload = e => {
        audioContext.decodeAudioData(e.target.result).then(buffer => {
          visualize(buffer);
          document.getElementById("spinner-outer").className = "hidden";
        }).catch(err => showError("L·ªói gi·∫£i m√£", err.message));
      };
      reader.onerror = err => showError("L·ªói ƒë·ªçc t·∫≠p tin", err.message);
      reader.readAsArrayBuffer(file);
      document.getElementById("spinner-outer").className = "";
    }

    function visualize(buffer) {
      audioBufferSourceNode = audioContext.createBufferSource();
      audioBufferSourceNode.buffer = buffer;
      analyser = audioContext.createAnalyser(); analyser.fftSize = 256;
      audioDrawingArray = new Uint8Array(analyser.frequencyBinCount);
      audioGainNode = audioContext.createGain(); audioGainNode.gain.value = volume;

      audioBufferSourceNode.connect(analyser);
      analyser.connect(audioGainNode);
      audioGainNode.connect(audioContext.destination);

      audioBufferSourceNode.start();
      audioPlaying = true;
      startTime = audioContext.currentTime;
      durationTime = buffer.duration;
      draw();

      audioBufferSourceNode.onended = () => { audioPlaying = false; cancelAnimationFrame(animationFrameId); showChooser(); };
      showScene();
    }

    const generateTime = s => `${String(Math.floor(s/60)).padStart(2,"0")}:${String(Math.floor(s%60)).padStart(2,"0")}`;

    function draw() {
      if (!audioPlaying) return;
      elapsedTime = audioContext.currentTime - startTime;
      document.getElementById('song-time').textContent = `${generateTime(elapsedTime)} / ${generateTime(durationTime)}`;
      analyser.getByteFrequencyData(audioDrawingArray);
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const barCount = 100, barWidth = canvas.width / barCount, centerY = canvas.height / 2, maxH = canvas.height*0.4;
      for (let i=0;i<barCount;i++){
        const val = audioDrawingArray[Math.floor(i/barCount*audioDrawingArray.length)]/255;
        const h = val*maxH;
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        ctx.fillRect(i*barWidth, centerY-h/2, barWidth-2, h);
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.fillRect(i*barWidth, centerY+h/2, barWidth-2, 2);
      }
      ctx.fillStyle = 'rgba(255,255,255,0.6)';
      for (let i=0;i<20;i++){
        const val = audioDrawingArray[Math.floor(Math.random()*audioDrawingArray.length)]/255;
        if (val>0.7){
          const x = Math.random()*canvas.width, y=Math.random()*canvas.height, size=val*5;
          ctx.beginPath(); ctx.arc(x,y,size,0,Math.PI*2); ctx.fill();
        }
      }
      animationFrameId = requestAnimationFrame(draw);
    }

    const showScene = () => { document.getElementById("chooser").className = "hidden"; document.getElementById("scene").className = "visible"; };
    const showChooser = () => { document.getElementById("chooser").className = ""; document.getElementById("scene").className = "hidden"; };
    const showError = (t, msg) => { document.getElementById("error-title").textContent = t; document.getElementById("error-text").textContent = msg; document.getElementById("error").className = ""; };
  </script>
</body>
</html>
