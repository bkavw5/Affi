<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizer Nh·∫°c v·ªõi D·∫£i Thanh Tr·∫Øng</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), url('https://hinhanhdep.net/wp-content/uploads/2017/11/hinh-nen-anime-4k-dep-17.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            text-align: center;
            padding: 20px;
            z-index: 10;
        }
        
        #chooser {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        #chooser-dialog {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-select {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed #ffffff;
            border-radius: 10px;
            padding: 15px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-select:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .file-select input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        button {
            background: linear-gradient(45deg, #ffffff, #cccccc);
            border: none;
            border-radius: 50px;
            color: #000000;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 255, 255, 0.3);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button.disabled {
            background: #666;
            cursor: not-allowed;
            box-shadow: none;
            color: #999;
        }
        
        #scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }
        
        #scene-canvas {
            width: 100%;
            height: 100%;
        }
        
        .audio-info {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 10;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            margin: 0 20px;
            backdrop-filter: blur(5px);
        }
        
        .audio-info div {
            margin: 5px 0;
        }
        
        #song-name {
            font-weight: bold;
            font-size: 18px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #song-time {
            font-size: 16px;
            color: #cccccc;
        }
        
        .hidden {
            display: none !important;
        }
        
        .visible {
            display: flex !important;
        }
        
        #spinner-outer {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
        }
        
        #error {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #error-dialog {
            background: #222;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }
        
        #error-title {
            color: #FF3366;
            margin-bottom: 15px;
            font-size: 24px;
        }
        
        #error-button {
            background: #FF3366;
            margin-top: 20px;
            color: white;
        }
        
        .title {
            font-size: 32px;
            margin-bottom: 10px;
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .subtitle {
            font-size: 18px;
            margin-bottom: 30px;
            color: #cccccc;
        }
        
        .volume-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 30px;
            backdrop-filter: blur(5px);
        }
        
        .volume-control span {
            margin-right: 10px;
            font-size: 20px;
        }
        
        .volume-control input {
            width: 100px;
        }
    </style>
</head>

<body id='pf_foto'>
    <div class="container">
        <h1 class="title"></h1>
        <p class="subtitle"></p>
        
        <div id='chooser'>
            <div id='chooser-dialog'>
                <input accept='image/*' id='verborgen_file' type='file'/>
                <button accept='image/*' id='uploadButton' type='button'>Ch·ªçn ·∫£nh n·ªÅn</button>
                
                <div class='file-upload'>
                    <div class='file-select'>
                        <input accept='audio/*' id='chooser-input' type='file'/> 
                        Ch·ªçn nh·∫°c c·∫ßn ph√°t (MP3, WAV, ...)
                    </div>
                </div>
                
                <p>Ch·ªâ nh·∫≠n file √¢m thanh. File s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω tr·ª±c ti·∫øp tr√™n tr√¨nh duy·ªát.</p>
                
                <div id='spinner-outer' class='hidden'>
                    <svg height='30' id='spinner' viewBox='0 0 30 30' width='30' xmlns='http://www.w3.org/2000/svg'>
                        <circle class='path' cx='15' cy='15' fill='none' r='13' stroke-linecap='round' stroke-width='2'/>
                    </svg>
                </div>
                
                <button id='chooser-button'>Ph√°t Nh·∫°c</button>
            </div>
        </div>
    </div>

    <div id='scene' class='hidden'>
        <canvas id='scene-canvas'></canvas>
    </div>

    <div class='audio-info'>
        <div id='song-name'>Ch∆∞a c√≥ b√†i h√°t</div>
        <div id='song-time'>00:00 / 00:00</div>
    </div>

    <div class="volume-control">
        <span>üîä</span>
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.75">
    </div>

    <div id='error' class='hidden'>
        <div id='error-dialog'>
            <h1 id='error-title'></h1>
            <p id='error-text'></p>
            <button id='error-button'>ƒê√≥ng</button>
        </div>
    </div>

    <script>
        // Code x·ª≠ l√Ω audio v√† visualizer
        let audioInput = null;
        let file = null;
        let fileName = "";
        let playButton = null;
        let buttonDisabled = true;
        let audioContext = null;
        let audioBufferSourceNode = null;
        let audioPlaying = false;
        let canvas = null;
        let ctx = null;
        let elapsedTime = 0;
        let startTime = 0;
        let durationTime = 0;
        let analyser = null;
        let audioDrawingArray = null;
        let animationFrameId = null;
        let volume = 0.75;
        let audioGainNode = null;

        // Kh·ªüi t·∫°o
        window.onload = function() {
            console.log("%cVisualizer Nh·∫°c v·ªõi D·∫£i Thanh Tr·∫Øng", "font-size: 1.5em; font-weight: bold; color: #ffffff");
            
            // Thi·∫øt l·∫≠p Audio Context
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            try {
                audioContext = new AudioContext();
            } catch(error) {
                console.error(error);
                showError("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£", "Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Web Audio API. Vui l√≤ng s·ª≠ d·ª•ng tr√¨nh duy·ªát hi·ªán ƒë·∫°i h∆°n.");
            }
            
            // Thi·∫øt l·∫≠p c√°c ph·∫ßn t·ª≠ UI
            audioInput = document.getElementById("chooser-input");
            audioInput.onchange = cbInputChange;
            
            playButton = document.getElementById("chooser-button");
            playButton.onclick = cbButtonClick;
            disableButton();
            
            canvas = document.getElementById("scene-canvas");
            ctx = canvas.getContext("2d");
            
            // Thi·∫øt l·∫≠p thanh volume
            const volumeSlider = document.getElementById("volume-slider");
            volumeSlider.addEventListener("input", function() {
                volume = parseFloat(this.value);
                if (audioGainNode) {
                    audioGainNode.gain.value = volume;
                }
            });
            
            // X·ª≠ l√Ω ch·ªçn ·∫£nh n·ªÅn
            document.getElementById('verborgen_file').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.body.style.backgroundImage = `linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), url(${event.target.result})`;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            document.getElementById('uploadButton').addEventListener('click', function() {
                document.getElementById('verborgen_file').click();
            });
            
            // X·ª≠ l√Ω n√∫t ƒë√≥ng l·ªói
            document.getElementById("error-button").onclick = cbErrorButtonClick;
            
            // Thi·∫øt l·∫≠p k√≠ch th∆∞·ªõc canvas
            resizeCanvas();
            window.addEventListener("resize", resizeCanvas);
        };

        function resizeCanvas() {
            if (canvas) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
        }

        function cbInputChange() {
            if(audioInput.files.length !== 0) {
                file = audioInput.files[0];
                fileName = file.name;
                
                // C·∫≠p nh·∫≠t t√™n b√†i h√°t
                document.getElementById('song-name').textContent = fileName;
                
                enableButton();
            }
        }

        function disableButton() {
            buttonDisabled = true;
            document.getElementById("chooser-button").className = "disabled";
        }

        function enableButton() {
            buttonDisabled = false;
            document.getElementById("chooser-button").className = "";
        }

        function cbButtonClick() {
            if(!buttonDisabled) {
                if(file.type.split("/")[0] === "audio") {
                    const fileReader = new FileReader();
                    fileReader.onload = function(e) {
                        const fileResult = e.target.result;
                        if(audioContext == null) {
                            return;
                        }
                        
                        audioContext.decodeAudioData(fileResult, function(buffer) {
                            visualize(buffer);
                            document.getElementById("spinner-outer").className = "hidden";
                        }, function(error) {
                            console.error(error);
                            showError("L·ªói khi gi·∫£i m√£ √¢m thanh", error.toString());
                            document.getElementById("spinner-outer").className = "hidden";
                        });
                    };
                    fileReader.onerror = function(error) {
                        console.error(error);
                        showError("L·ªói khi ƒë·ªçc t·∫≠p tin", error.toString());
                        document.getElementById("spinner-outer").className = "hidden";
                    };
                    
                    fileReader.readAsArrayBuffer(file);
                    
                    document.getElementById("spinner-outer").className = "";
                } else {
                    showError("L·ªói!!!", "Vui l√≤ng ch·ªçn file nh·∫°c (MP3, WAV, ...).");
                }
            }
        }

        function showScene() {
            document.getElementById("chooser").className = "hidden";
            document.getElementById("scene").className = "visible";
        }

        function showChooser() {
            document.getElementById("chooser").className = "";
            document.getElementById("scene").className = "hidden";
        }

        function visualize(buffer) {
            if (!audioContext) return;
            
            // T·∫°o n√∫t ngu·ªìn √¢m thanh
            audioBufferSourceNode = audioContext.createBufferSource();
            audioBufferSourceNode.buffer = buffer;
            
            // Thi·∫øt l·∫≠p b·ªô ph√¢n t√≠ch
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            audioDrawingArray = new Uint8Array(analyser.frequencyBinCount);
            
            // Thi·∫øt l·∫≠p b·ªô khu·∫øch ƒë·∫°i √¢m l∆∞·ª£ng
            audioGainNode = audioContext.createGain();
            audioGainNode.gain.value = volume;
            
            // K·∫øt n·ªëi c√°c n√∫t
            audioBufferSourceNode.connect(analyser);
            analyser.connect(audioGainNode);
            audioGainNode.connect(audioContext.destination);
            
            // B·∫Øt ƒë·∫ßu ph√°t nh·∫°c
            audioBufferSourceNode.start();
            audioPlaying = true;
            startTime = audioContext.currentTime;
            durationTime = buffer.duration;
            
            // B·∫Øt ƒë·∫ßu v·∫Ω visualizer
            draw();
            
            // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫°c k·∫øt th√∫c
            audioBufferSourceNode.onended = function() {
                audioPlaying = false;
                if(animationFrameId !== null) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                showChooser();
            };
            
            // Hi·ªÉn th·ªã scene
            showScene();
        }

        function generateTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes < 10 ? '0' + minutes : minutes}:${secs < 10 ? '0' + secs : secs}`;
        }

        function draw() {
            if (!audioPlaying) return;
            
            // C·∫≠p nh·∫≠t th·ªùi gian
            elapsedTime = audioContext.currentTime - startTime;
            document.getElementById('song-time').textContent = 
                `${generateTime(elapsedTime)} / ${generateTime(durationTime)}`;
            
            // L·∫•y d·ªØ li·ªáu t·∫ßn s·ªë
            analyser.getByteFrequencyData(audioDrawingArray);
            
            // X√≥a canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // V·∫Ω d·∫£i thanh tr·∫Øng nh·∫•p nh√¥
            const barCount = 100; // S·ªë l∆∞·ª£ng thanh
            const barWidth = canvas.width / barCount;
            const centerY = canvas.height / 2;
            const maxBarHeight = canvas.height * 0.4;
            
            for (let i = 0; i < barCount; i++) {
                // L·∫•y gi√° tr·ªã t·∫ßn s·ªë t∆∞∆°ng ·ª©ng
                const value = audioDrawingArray[Math.floor(i / barCount * audioDrawingArray.length)] / 255;
                const barHeight = value * maxBarHeight;
                
                // V·∫Ω thanh
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.fillRect(i * barWidth, centerY - barHeight/2, barWidth - 2, barHeight);
                
                // Hi·ªáu ·ª©ng ph·∫£n chi·∫øu
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fillRect(i * barWidth, centerY + barHeight/2, barWidth - 2, 2);
            }
            
            // Hi·ªáu ·ª©ng h·∫°t particle
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            for (let i = 0; i < 20; i++) {
                const index = Math.floor(Math.random() * audioDrawingArray.length);
                const intensity = audioDrawingArray[index] / 255;
                
                if (intensity > 0.7) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const size = intensity * 5;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // Ti·∫øp t·ª•c v·∫Ω
            animationFrameId = requestAnimationFrame(draw);
        }

        function showError(title, text) {
            document.getElementById("error-title").innerHTML = title;
            document.getElementById("error-text").innerHTML = text;
            document.getElementById("error").className = "";
        }

        function cbErrorButtonClick() {
            document.getElementById("error").className = "hidden";
        }
    </script>
</body>
</html>

